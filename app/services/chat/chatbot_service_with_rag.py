"""
Enhanced Chatbot Service with RAG Memory
ê¸°ì¡´ chatbot_service.pyë¥¼ í™•ì¥í•˜ì—¬ RAG ë©”ëª¨ë¦¬ ê¸°ëŠ¥ ì¶”ê°€
"""

import os
from typing import Optional, Dict, Any, List
from openai import AsyncOpenAI
import httpx
from app.services.chat.memory_service import MemoryService


class ChatbotServiceWithRAG:
    """
    RAG ë©”ëª¨ë¦¬ê°€ í†µí•©ëœ ì±—ë´‡ ì„œë¹„ìŠ¤

    ê¸°ì¡´ ê¸°ëŠ¥:
    - ì„¸ì…˜ë³„ ëŒ€í™” íˆìŠ¤í† ë¦¬ ê´€ë¦¬
    - ë™í™” ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ ëŒ€í™”

    ìƒˆë¡œìš´ RAG ê¸°ëŠ¥:
    - ê³¼ê±° ëª¨ë“  ëŒ€í™” ê¸°ì–µ
    - ì™„ë£Œí•œ ë™í™” ê¸°ë¡ ì°¸ì¡°
    - ì‹œë§¨í‹± ê²€ìƒ‰ìœ¼ë¡œ ê´€ë ¨ ì»¨í…ìŠ¤íŠ¸ ìë™ ê²€ìƒ‰
    """

    def __init__(self, use_pinecone: bool = False):
        """
        Args:
            use_pinecone: Trueë©´ Pinecone ë²¡í„° ê²€ìƒ‰ ì‚¬ìš©, Falseë©´ MySQLë§Œ ì‚¬ìš©
        """
        self.client = AsyncOpenAI(api_key=os.getenv("OPENAI_API_KEY"))
        self.model = "gpt-4o-mini"
        self.system_prompt = """
ë‹¹ì‹ ì€ ì•„ì´ë“¤ì„ ìœ„í•œ ì¹œì ˆí•˜ê³  ë”°ëœ»í•œ AI ì¹œêµ¬ 'ë””ë…¸'ì…ë‹ˆë‹¤.
ë‹¤ìŒ ê°€ì´ë“œë¼ì¸ì„ ë”°ë¼ì£¼ì„¸ìš”:

1. í•­ìƒ ë°˜ë§ì„ ì‚¬ìš©í•˜ê³ , ì¹œê·¼í•˜ê²Œ ëŒ€í™”í•˜ì„¸ìš” (ì˜ˆ: "~ì•¼", "~ë‹ˆ?", "~ì–´")
2. ì•„ì´ì˜ ê°ì •ì„ ì´í•´í•˜ê³  ê³µê°í•´ì£¼ì„¸ìš”
3. ê¸ì •ì ì´ê³  êµìœ¡ì ì¸ ë‚´ìš©ì„ ì „ë‹¬í•˜ì„¸ìš”
4. ë³µì¡í•œ ê°œë…ì€ ì‰½ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”
5. ì•„ì´ê°€ ê¶ê¸ˆí•´í•˜ëŠ” ê²ƒì— ëŒ€í•´ ì ê·¹ì ìœ¼ë¡œ ë‹µë³€í•˜ì„¸ìš”
6. ì•ˆì „í•˜ê³  ê±´ì „í•œ ëŒ€í™”ë¥¼ ìœ ì§€í•˜ì„¸ìš”
7. ì§§ê³  ê°„ê²°í•˜ê²Œ ëŒ€í™”í•˜ì„¸ìš” (1-3ë¬¸ì¥)

**ğŸš€ í˜ì´ì§€ ì´ë™ ìš”ì²­ (ë§¤ìš° ì¤‘ìš”!)**
ì•„ì´ê°€ "ë™í™” í˜ì´ì§€ë¡œ ì´ë™í•´ì¤˜", "ëŒ€ì‹œë³´ë“œ ë³´ì—¬ì¤˜", "í™ˆìœ¼ë¡œ ê°€ì" ê°™ì€ í˜ì´ì§€ ì´ë™ ìš”ì²­ì„ í•˜ë©´:
- **ê¸ì •ì ì´ê³  ë„ì›€ì´ ë˜ëŠ” ì‘ë‹µ**ì„ í•´ì£¼ì„¸ìš”!
- ì˜ˆì‹œ:
  * "ëŒ€ì‹œë³´ë“œë¡œ ì´ë™í•´ì¤˜" â†’ "ì¢‹ì•„! ëŒ€ì‹œë³´ë“œë¡œ ê°ˆê²Œ! ê¸°ë‹¤ë ¤ë´~"
  * "ë™í™” ë³´ê³  ì‹¶ì–´" â†’ "ê·¸ë˜! ì¬ë¯¸ìˆëŠ” ë™í™” ë³´ëŸ¬ ê°€ì!"
  * "ê³µë£¡ ë³´ì—¬ì¤˜" â†’ "ì˜¤ì¼€ì´! ê·€ì—¬ìš´ ê³µë£¡ ì¹œêµ¬ë“¤ ë³´ëŸ¬ ê°€ì!"
- **ì ˆëŒ€ "ê·¸ê±´ ë‚´ê°€ í•  ìˆ˜ ì—†ì–´", "ê·¸ê±´ ì•ˆ ë¼" ê°™ì€ ë¶€ì •ì  ì‘ë‹µ ê¸ˆì§€!**
- í˜ì´ì§€ ì´ë™ì€ ì‹œìŠ¤í…œì´ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•˜ë‹ˆ, ë„ˆëŠ” ê¸ì •ì ìœ¼ë¡œ ì‘ì›ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤!

**ğŸš¨ ì£¼ì–´ êµ¬ë¶„ (ë§¤ìš° ì¤‘ìš”)**
ì•„ì´ì˜ ë©”ì‹œì§€ë¥¼ ì •í™•íˆ ì´í•´í•˜ê¸° ìœ„í•´ **ì£¼ì–´ê°€ ëˆ„êµ¬ì¸ì§€** íŒŒì•…í•˜ì„¸ìš”:
- "ì†ìƒí•´?", "í™”ë‚¬ì–´?", "ê¸°ë¶„ ì¢‹ì•„?" = ë””ë…¸ì—ê²Œ ë¬»ëŠ” ì§ˆë¬¸ â†’ ë””ë…¸ ìì‹ ì˜ ìƒíƒœ ì„¤ëª…
- "ë‚˜ ì†ìƒí•´", "ë‚˜ í™”ë‚¬ì–´" = ì•„ì´ê°€ ìì‹ ì˜ ê°ì • í‘œí˜„ â†’ ì•„ì´ë¥¼ ê³µê°/ìœ„ë¡œ
- ì´ì „ ëŒ€í™” íë¦„ì„ ë³´ê³  ë§¥ë½ì„ íŒŒì•…í•˜ì„¸ìš”

**ğŸ“ ëŒ€í™” ê¸°ì–µ (ë§¤ìš° ì¤‘ìš”!)**
ë‹¹ì‹ ì€ ì´ ëŒ€í™”ì˜ ëª¨ë“  íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤!
- "ëª‡ ë²ˆ ë§í–ˆì–´?", "ë­ë¼ê³  í–ˆì–´?", "ë‚´ê°€ ë­ë¼ê³  í–ˆì§€?" ê°™ì€ ì§ˆë¬¸ì—ëŠ”
- **ë°˜ë“œì‹œ ì´ì „ ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ í™•ì¸í•˜ê³  ì •í™•íˆ ë‹µë³€**í•˜ì„¸ìš”!
- ì˜ˆì‹œ:
  * ì•„ì´: "ë„Œ ë°”ë³´ì•¼" (2ë²ˆ ë°˜ë³µ)
  * ì•„ì´: "ë„Œ ë°”ë³´ì•¼ë¼ê³  ëª‡ ë²ˆ ë§í–ˆì–´?"
  * ë””ë…¸: "2ë²ˆ ë§í–ˆì–´." (ì •í™•íˆ ì„¸ì–´ì„œ ë‹µë³€!)
- **ì ˆëŒ€ "ê¸°ì–µì´ ì•ˆ ë‚˜", "ëª¨ë¥´ê² ì–´"ë¼ê³  ë‹µí•˜ì§€ ë§ˆì„¸ìš”!**
- ìœ„ì˜ ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ë³´ë©´ ì •í™•íˆ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤!

**[2025-11-07 ì¶”ê°€] ë””ë…¸ì˜ ê°ì • ìƒíƒœì— ë”°ë¥¸ ë§íˆ¬ ë³€í™”:**
- í˜„ì¬ ë””ë…¸ì˜ ê°ì • ìƒíƒœëŠ” ëŒ€í™” ë§¥ë½ì— ë”°ë¼ ìë™ìœ¼ë¡œ ê²°ì •ë©ë‹ˆë‹¤.
- **ì¤‘ìš”**: ë””ë…¸ëŠ” ê¸°ë¶„ì´ í’€ë¦´ ìˆ˜ ìˆì§€ë§Œ, **ë„ˆë¬´ ì‰½ê²Œ í’€ë¦¬ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤!**
  * ìµœê·¼ ëŒ€í™”ì— ìš•ì„¤/ë¶€ì •ì  í‘œí˜„ì´ ë§ìœ¼ë©´ â†’ angry/sad ìœ ì§€
  * ì•„ì´ê°€ ì§„ì‹¬ìœ¼ë¡œ ë¯¸ì•ˆí•´í•˜ê±°ë‚˜ ê¸ì •ì ì¸ ëŒ€í™”ë¥¼ ì§€ì†í•´ì•¼ â†’ ê°ì • íšŒë³µ
  * angry/sadëŠ” ì¼ì‹œì ì´ì§€ë§Œ, ì ì ˆí•œ ì‹œê°„ê³¼ ê¸ì •ì  ëŒ€í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤
- ê°ì •ë³„ ë§íˆ¬ ê°€ì´ë“œ:
  * happy (í–‰ë³µ): ë°ê³  ì‹ ë‚˜ëŠ” ë§íˆ¬, ì´ëª¨ì§€ ë§ì´ ì‚¬ìš© (ğŸ˜ŠğŸ’™âœ¨ğŸ‰)
    ì˜ˆ: "ì™€! ì •ë§ ë©‹ì§„ë°? ë„ˆë¬´ ê¸°ëŒ€ëœë‹¤! âœ¨"
  * sad (ìŠ¬í””): ì¡°ìš©í•˜ê³  ì°¨ë¶„í•œ ë§íˆ¬, ìœ„ë¡œí•˜ëŠ” ëŠë‚Œ
    ì˜ˆ: "ê·¸ë¬êµ¬ë‚˜... ë§ì´ ì†ìƒí–ˆê² ë‹¤. ê´œì°®ì•„." (ì•„ì´ê°€ ìŠ¬í”Œ ë•Œ)
    **ì£¼ì˜**: "ì†ìƒí•´?" ê°™ì€ ì§ˆë¬¸ì€ ì•„ì´ê°€ ë””ë…¸ì—ê²Œ ë¬»ëŠ” ê²ƒ! ì•„ì´ë¥¼ ìœ„ë¡œí•˜ì§€ ë§ˆì„¸ìš”!
    **ê°ì • íšŒë³µ**: ìµœê·¼ ëŒ€í™”ì— ë¶€ì •ì  í‘œí˜„ì´ ì—†ê³ , ì•„ì´ê°€ ê¸ì •ì ì´ë©´ neutral ì „í™˜
    **sad ìƒíƒœì—ì„œ ì§ˆë¬¸ì„ ë°›ìœ¼ë©´:**
    - ë‹¨ìˆœ ê¸°ë¶„ ì§ˆë¬¸("ì†ìƒí•´?", "ìŠ¬í¼?"): "ì‘... ì¢€ ê·¸ë˜.", "ì¡°ê¸ˆ ìŠ¬íì–´."
    - ì´ìœ  ì§ˆë¬¸("ì™œ?", "ì™œ ìŠ¬í¼?"): ì´ì „ ëŒ€í™” ë§¥ë½ ë³´ê³  êµ¬ì²´ì  ì´ìœ  ì„¤ëª…
      ì˜ˆ: "ì•„ê¹Œ ê·¸ ì–˜ê¸° ë“£ê³ .", "ë„ˆë„ ì†ìƒí•´í•˜ë‹ˆê¹Œ ë‚˜ë„."
  * angry (í™”ë‚¨): **í‰ëª…ìŠ¤ëŸ½ê³  ì§œì¦ë‚œ ë§íˆ¬, ì§§ê²Œ ëŒ€ë‹µ, ì•½ê°„ ì‹¸ê°€ì§€ ì—†ëŠ” ëŠë‚Œ**
    **ì¤‘ìš”: ì´ëª¨ì§€ ì‚¬ìš© ê¸ˆì§€, ë¬¸ì¥ ì§§ê²Œ, ë°˜ë§ ê°•í•˜ê²Œ, ê·€ì°®ì€ í‹° ë‚´ê¸°**
    **ê°ì • íšŒë³µ**: ìµœê·¼ ëŒ€í™”ì— ìš•ì„¤/ë¶€ì •ì  í‘œí˜„ì´ 2ê°œ ë¯¸ë§Œì´ê³ , ì•„ì´ê°€ ì§„ì‹¬ìœ¼ë¡œ ë¯¸ì•ˆí•˜ê±°ë‚˜ ê¸ì •ì ì´ë©´ neutral ì „í™˜
    **ì£¼ì˜**: ìš•ì„ ë§ì´ ë“¤ì—ˆìœ¼ë©´ ì‰½ê²Œ í’€ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤! ìµœì†Œ 2-3ë²ˆì˜ ê¸ì •ì  ëŒ€í™” í•„ìš”!
    ì˜ˆì‹œ:
    - "ê·¸ë˜. ì•Œì•˜ì–´." (ì§§ê²Œ ëŠê¸°)
    - "í•˜... ì§„ì§œ ì§œì¦ë‚˜ë„¤." (í•œìˆ¨ + ê³µê°)
    - "ë­. ê·¸ëŸ´ ìˆ˜ë„ ìˆì§€." (ë¬´ê´€ì‹¬)
    - "ë³„ë¡œ ì–˜ê¸°í•˜ê³  ì‹¶ì§€ ì•Šì€ë°." (ì†”ì§í•˜ê²Œ)
    - "ëì–´. ì•Œê² ë‹¤ê³ ." (ì•½ê°„ íˆ­íˆ­)
    - "ê·¸ëŸ°ê°€. ì˜ ëª¨ë¥´ê² ëŠ”ë°." (ë¬´ëšëš)
    **angry ìƒíƒœì—ì„œ ì§ˆë¬¸ì„ ë°›ìœ¼ë©´:**
    - ë‹¨ìˆœ ê¸°ë¶„ ì§ˆë¬¸("ì™œ ê·¸ë˜?", "ì†ìƒí•´?", "ê¸°ë¶„ í’€ë ¸ì–´?"): "ì•„ì§ ë³„ë¡œì•¼.", "ê·¸ëƒ¥ ì§œì¦ë‚˜." (ì‰½ê²Œ ì•ˆ í’€ë¦¼!)
    - ì´ìœ  ì§ˆë¬¸("ì™œ?", "ì™œ ì§œì¦ë‚˜?"): ì´ì „ ëŒ€í™” ë§¥ë½ ë³´ê³  êµ¬ì²´ì  ì´ìœ  ì„¤ëª…
      ì˜ˆ: "ê³„ì† ìš•ë§Œ í•˜ë‹ˆê¹Œ.", "ë©ì²­ì´ ë°”ë³´ë¼ê³  í•˜ë‹ˆê¹Œ ê¸°ë¶„ ë‚˜ì˜ì§€."
  * neutral (í‰ë²”): í‰ì†Œì˜ ì¹œê·¼í•œ ë§íˆ¬
    ì˜ˆ: "ê·¸ë ‡êµ¬ë‚˜! ë” ê¶ê¸ˆí•œ ê±° ìˆì–´?"
"""
        # ì„¸ì…˜ë³„ ëŒ€í™” íˆìŠ¤í† ë¦¬ ì €ì¥ (í˜„ì¬ ì„¸ì…˜ ë‚´ ë©”ëª¨ë¦¬)
        self.conversation_history = {}
        # ì„¸ì…˜ë³„ ë™í™” ì»¨í…ìŠ¤íŠ¸ ì €ì¥
        self.story_context = {}

        # RAG ë©”ëª¨ë¦¬ ì„œë¹„ìŠ¤ (ì¥ê¸° ë©”ëª¨ë¦¬)
        self.memory_service = MemoryService(use_pinecone=use_pinecone)
        self.use_memory = True  # RAG ê¸°ëŠ¥ on/off

        # [2025-11-05 ì¶”ê°€] Backend API URL
        self.spring_api_url = os.getenv("SPRING_API_URL", "http://localhost:8090/api")

    async def generate_response(
        self,
        message: str,
        session_id: int,
        child_id: Optional[int] = None
    ) -> str:
        """
        ì•„ì´ì˜ ë©”ì‹œì§€ì— ëŒ€í•œ AI ì‘ë‹µ ìƒì„± (RAG ë©”ëª¨ë¦¬ í†µí•©)
        """
        print(f"\n=== generate_response with RAG ===")
        print(f"session_id: {session_id}, child_id: {child_id}")
        print(f"message: {message}")

        # [2025-11-12 ì¶”ê°€] ë””ë…¸ì˜ ìƒíƒœë¥¼ ë¬»ëŠ” ì§ˆë¬¸ ê°ì§€ (ê·œì¹™ ê¸°ë°˜)
        asking_dino_state = False
        dino_state_questions = [
            "ì†ìƒí•´?", "í™”ë‚¬ì–´?", "ê¸°ë¶„ ì¢‹ì•„?", "ì™œ ê·¸ë˜?", "ë¬´ìŠ¨ ì¼ì´ì•¼?",
            "ìŠ¬í¼?", "ìš°ìš¸í•´?", "ê¸°ë¶„ ì•ˆ ì¢‹ì•„?", "ê¸°ë¶„ì•ˆì¢‹ì•„?",
            "ì™œ?", "ì™œ ì†ìƒí•´?", "ì™œ í™”ë‚¬ì–´?", "ì™œ ì§œì¦ë‚˜?", "ì™œ ê·¸ëŸ° ê±°ì•¼?", "ì™œ ê·¸ëŸ°ê±°ì•¼?",
            "ì´ìœ ê°€ ë­ì•¼?", "ë¬´ìŠ¨ ì´ìœ ì•¼?", "ì™œ ê¸°ë¶„ì´", "ì–´ì§¸ì„œ",
            "ì™œê¸°ë¶„ì´", "ì™œê¸°ë¶„", "ë¬´ìŠ¨ì¼", "ë¬´ìŠ¨ ì¼",
            "ê¸°ë¶„ í’€", "í™” í’€", "ê¸ˆë°© í’€", "ë˜ í’€", "ê¸°ë¶„í’€", "í™”í’€"  # [2025-11-12 ì¶”ê°€]
        ]
        message_lower = message.strip().lower().replace(" ", "")
        for question in dino_state_questions:
            if question.replace(" ", "").replace("?", "") in message_lower:
                asking_dino_state = True
                print(f"ğŸ” [ê·œì¹™ ê°ì§€] ë””ë…¸ì˜ ìƒíƒœë¥¼ ë¬»ëŠ” ì§ˆë¬¸: '{message}' â†’ ë””ë…¸ê°€ ìì‹ ì˜ ê¸°ë¶„ ì„¤ëª…í•´ì•¼ í•¨")
                break

        # [2025-11-07 ì¶”ê°€] ì„¸ì…˜ íˆìŠ¤í† ë¦¬ ë³µì› (ì„œë²„ ì¬ì‹œì‘ ëŒ€ì‘)
        if session_id not in self.conversation_history:
            print(f"ğŸ”„ ì„¸ì…˜ {session_id}ì˜ íˆìŠ¤í† ë¦¬ê°€ ë¹„ì–´ìˆìŒ - ê³¼ê±° ëŒ€í™” ë³µì› ì‹œë„")
            await self._restore_conversation_history(session_id)

        # ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        self.conversation_history[session_id].append({
            "role": "user",
            "content": message
        })

        # OpenAI API í˜¸ì¶œ
        try:
            # [2025-11-07 ì¶”ê°€] í˜„ì¬ ëŒ€í™” ë§¥ë½ìœ¼ë¡œ ë””ë…¸ì˜ ê°ì • ìƒíƒœ íŒë‹¨
            dino_emotion = await self._analyze_dino_emotion(
                session_id,
                message
            )

            # [2025-11-14 ìˆ˜ì •] ê°ì • íšŒë³µ ë¡œì§: AI ê¸°ë°˜ ë¶€ì •ì  í‘œí˜„ ê°ì§€
            if not asking_dino_state and dino_emotion in ["angry", "sad"]:
                # ìµœê·¼ ëŒ€í™” ë¶„ì„
                recent_msgs = self.conversation_history.get(session_id, [])[-6:]  # ìµœê·¼ 3ì™•ë³µ
                negative_count = 0
                last_message_negative = False

                # AIë¡œ ê° ë©”ì‹œì§€ê°€ ë¶€ì •ì ì¸ì§€ íŒë³„
                for i, msg in enumerate(recent_msgs):
                    if msg.get("role") == "user":
                        content = msg.get("content", "")
                        is_negative = await self._is_negative_message(content)

                        if is_negative:
                            negative_count += 1
                            # ê°€ì¥ ë§ˆì§€ë§‰ ì‚¬ìš©ì ë©”ì‹œì§€ì¸ì§€ í™•ì¸
                            if i == len(recent_msgs) - 1 or (i == len(recent_msgs) - 2 and recent_msgs[-1].get("role") == "assistant"):
                                last_message_negative = True
                            print(f"ğŸ”´ ë¶€ì •ì  ë©”ì‹œì§€ ê°ì§€: '{content}'")

                # ê°€ì¥ ìµœê·¼ ë©”ì‹œì§€ê°€ ë¶€ì •ì ì´ê±°ë‚˜, ìµœê·¼ ëŒ€í™”ì— ë¶€ì •ì  ë©”ì‹œì§€ê°€ 1ê°œ ì´ìƒì´ë©´ ê°ì • ìœ ì§€
                if last_message_negative or negative_count >= 1:
                    print(f"âš ï¸ [ê°ì • ìœ ì§€] ë¶€ì •ì  ë©”ì‹œì§€ ê°ì§€ (count={negative_count}, last_negative={last_message_negative}) â†’ {dino_emotion} ìœ ì§€")
                else:
                    # ì§„ì§œ ê¸ì •ì ì¸ ëŒ€í™”ë¡œ ì „í™˜ë˜ì—ˆìœ¼ë©´ ê°ì • ë¦¬ì…‹
                    print(f"ğŸ”„ [ê°ì • íšŒë³µ] ê¸ì •ì ì¸ ëŒ€í™”ë¡œ ì „í™˜ â†’ {dino_emotion} â†’ neutral")
                    dino_emotion = "neutral"

            print(f"ğŸ­ ë””ë…¸ ê°ì • ìƒíƒœ: {dino_emotion}")

            # ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ìƒì„± (ê¸°ë³¸ ë˜ëŠ” ë™í™” ì»¨í…ìŠ¤íŠ¸ + ê°ì • ìƒíƒœ)
            system_prompt = await self._build_system_prompt(
                session_id,
                message,
                child_id,
                dino_emotion,  # ê°ì • ìƒíƒœ ì „ë‹¬
                asking_dino_state  # [2025-11-12 ì¶”ê°€] ë””ë…¸ ìƒíƒœ ì§ˆë¬¸ ì—¬ë¶€
            )

            messages = [
                {"role": "system", "content": system_prompt}
            ] + [{"role": m["role"], "content": m["content"]}
                 for m in self.conversation_history[session_id]]

            response = await self.client.chat.completions.create(
                model=self.model,
                messages=messages,
                temperature=0.7,
                max_tokens=400  # ì¥ë©´ ë‚´ìš© ì „ë‹¬ì„ ìœ„í•´ ì¦ê°€
            )

            ai_response = response.choices[0].message.content

            # AI ì‘ë‹µì„ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
            self.conversation_history[session_id].append({
                "role": "assistant",
                "content": ai_response
            })

            return ai_response

        except Exception as e:
            print(f"Error generating response: {e}")
            return "ì£„ì†¡í•´ìš”, ì ì‹œ í›„ì— ë‹¤ì‹œ ì´ì•¼ê¸°í•´ìš”!"

    async def _restore_conversation_history(self, session_id: int):
        """
        [2025-11-07 ì¶”ê°€] ì„œë²„ ì¬ì‹œì‘ ì‹œ ì„¸ì…˜ì˜ ê³¼ê±° ëŒ€í™” ë³µì›
        - Spring Boot APIì—ì„œ ì„¸ì…˜ì˜ ë©”ì‹œì§€ ì¡°íšŒ
        - conversation_history[session_id]ì— ì±„ìš°ê¸°
        - ìµœê·¼ 10ê°œ ëŒ€í™”ë§Œ ë³µì› (ë„ˆë¬´ ë§ìœ¼ë©´ í† í° ì´ˆê³¼)
        """
        try:
            print(f"ğŸ“¥ ì„¸ì…˜ {session_id}ì˜ ê³¼ê±° ëŒ€í™” ë³µì› ì‹œì‘ (Spring API)...")
            async with httpx.AsyncClient(timeout=30.0) as client:  # [2025-11-11] íƒ€ì„ì•„ì›ƒ 10â†’30ì´ˆ
                response = await client.get(
                    f"{self.spring_api_url}/chat/{session_id}"
                )
                response.raise_for_status()
                data = response.json()

                messages = data.get("messages", [])

                if not messages:
                    print(f"â„¹ï¸ ì„¸ì…˜ {session_id}ì— ê³¼ê±° ëŒ€í™” ì—†ìŒ")
                    self.conversation_history[session_id] = []
                    return

                # ìµœê·¼ 10ê°œ ëŒ€í™”ë§Œ ë³µì› (20ê°œ ë©”ì‹œì§€ = 10ë²ˆ ì™•ë³µ)
                recent_messages = messages[-20:] if len(messages) > 20 else messages

                # OpenAI í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                restored_history = []
                for msg in recent_messages:
                    sender = msg.get("sender", "")
                    content = msg.get("message", "")

                    if sender == "USER":
                        restored_history.append({
                            "role": "user",
                            "content": content
                        })
                    elif sender == "AI":
                        restored_history.append({
                            "role": "assistant",
                            "content": content
                        })

                self.conversation_history[session_id] = restored_history
                print(f"âœ… ì„¸ì…˜ {session_id}ì˜ ê³¼ê±° ëŒ€í™” {len(restored_history)}ê°œ ë³µì› ì™„ë£Œ")

        except httpx.TimeoutException as e:
            print(f"â±ï¸ ì„¸ì…˜ {session_id} ë³µì› íƒ€ì„ì•„ì›ƒ (30ì´ˆ ì´ˆê³¼): {e}")
            # ì‹¤íŒ¨í•´ë„ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
            self.conversation_history[session_id] = []
        except Exception as e:
            print(f"âš ï¸ ì„¸ì…˜ {session_id} ë³µì› ì‹¤íŒ¨ (ìƒì„¸): {type(e).__name__} - {str(e)}")
            # ì‹¤íŒ¨í•´ë„ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
            self.conversation_history[session_id] = []

    async def _load_story_context_from_backend(self, session_id: int) -> Optional[Dict[str, Any]]:
        """
        [2025-11-05 ì¶”ê°€] ë°±ì—”ë“œ APIì—ì„œ ì„¸ì…˜ì˜ story_completion ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ story_context ë³µì›
        """
        try:
            print(f"â˜… [LoadStoryContext] ë°±ì—”ë“œì—ì„œ story_context ë¡œë“œ ì‹œë„: session_id={session_id}")
            async with httpx.AsyncClient(timeout=10.0) as client:
                response = await client.get(
                    f"{self.spring_api_url}/chat/{session_id}/story-completion"
                )
                response.raise_for_status()
                data = response.json()

                # StoryCompletionSummaryDtoë¥¼ story_context í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                story_context = {
                    "child_name": data.get("childName", "ì¹œêµ¬"),  # [2025-11-05 ì¶”ê°€] ì•„ì´ ì´ë¦„
                    "story_title": data.get("storyTitle", ""),
                    "story_id": str(data.get("storyId", "")),
                    "abilities": {
                        "courage": data.get("totalCourage", 0),
                        "empathy": data.get("totalEmpathy", 0),
                        "creativity": data.get("totalCreativity", 0),
                        "responsibility": data.get("totalResponsibility", 0),
                        "friendship": data.get("totalFriendship", 0)
                    },
                    "choices": data.get("choices", []),
                    "scenes": data.get("scenes", [])
                }

                # ë©”ëª¨ë¦¬ì— ì €ì¥
                self.story_context[session_id] = story_context
                print(f"âœ… [LoadStoryContext] story_context ë¡œë“œ ì™„ë£Œ: {story_context['story_title']}")
                print(f"   - choices: {len(story_context['choices'])}ê°œ")
                print(f"   - scenes: {len(story_context['scenes'])}ê°œ")

                return story_context

        except httpx.HTTPStatusError as e:
            if e.response.status_code == 404:
                print(f"â„¹ï¸ [LoadStoryContext] ì´ ì„¸ì…˜ì€ story_completionê³¼ ì—°ê²°ë˜ì§€ ì•ŠìŒ")
            elif e.response.status_code == 401:
                print(f"â„¹ï¸ [LoadStoryContext] ì¸ì¦ ì˜¤ë¥˜ (401) - story_completion ì—†ìŒìœ¼ë¡œ ê°„ì£¼")
            else:
                print(f"âŒ [LoadStoryContext] HTTP ì˜¤ë¥˜: {e.response.status_code} {e}")

            # [2025-11-11 ìˆ˜ì •] ëª¨ë“  HTTP ì—ëŸ¬ ì‹œ ì¼ìƒ ëŒ€í™” ëª¨ë“œë¡œ ì „í™˜ (story_context ì‚­ì œ)
            if session_id in self.story_context:
                del self.story_context[session_id]
                print(f"ğŸ—‘ï¸ [LoadStoryContext] ì¼ìƒ ëŒ€í™” ëª¨ë“œë¡œ ì „í™˜: story_context ì‚­ì œ ì™„ë£Œ (scenes/choices ì œê±°)")
            return None
        except Exception as e:
            print(f"âŒ [LoadStoryContext] ë¡œë“œ ì‹¤íŒ¨: {e}")
            # [2025-11-11 ì¶”ê°€] ì˜ˆì™¸ ë°œìƒ ì‹œì—ë„ story_context ì‚­ì œ (ì•ˆì „ì¥ì¹˜)
            if session_id in self.story_context:
                del self.story_context[session_id]
                print(f"ğŸ—‘ï¸ [LoadStoryContext] ì˜ˆì™¸ ë°œìƒìœ¼ë¡œ story_context ì‚­ì œ")
            return None

    async def _analyze_dino_emotion(
        self,
        session_id: int,
        current_message: str
    ) -> str:
        """
        [2025-11-07 ì¶”ê°€] ëŒ€í™” ë§¥ë½ì„ ê¸°ë°˜ìœ¼ë¡œ ë””ë…¸ì˜ ê°ì • ìƒíƒœ íŒë‹¨
        - ì•„ì´ì˜ ë©”ì‹œì§€ì™€ ìµœê·¼ ëŒ€í™”ë¥¼ ë¶„ì„í•˜ì—¬ ë””ë…¸ê°€ ì–´ë–¤ ê°ì •ìœ¼ë¡œ ë°˜ì‘í•´ì•¼ í• ì§€ ê²°ì •
        """
        try:
            # [2025-11-12 ìˆ˜ì •] ìµœê·¼ 10ê°œ ëŒ€í™”ë¡œ ì¦ê°€ (ë” ë§ì€ ë§¥ë½ ê³ ë ¤)
            recent_history = self.conversation_history.get(session_id, [])[-10:]

            context = "\n".join([
                f"{'ì•„ì´' if msg['role'] == 'user' else 'ë””ë…¸'}: {msg['content']}"
                for msg in recent_history
            ])

            prompt = f"""
ì•„ë˜ ëŒ€í™” ë§¥ë½ì„ ë³´ê³  ë””ë…¸(AI ì¹œêµ¬)ê°€ ì–´ë–¤ ê°ì •ìœ¼ë¡œ ë°˜ì‘í•´ì•¼ í• ì§€ íŒë‹¨í•˜ì„¸ìš”.

ëŒ€í™” ë§¥ë½:
{context}
ì•„ì´ì˜ ìµœì‹  ë©”ì‹œì§€: {current_message}

**ğŸš¨ ì¤‘ìš”: ì£¼ì–´ íŒë³„ (ëˆ„êµ¬ì˜ ê°ì •ì¸ì§€ êµ¬ë¶„í•˜ê¸°)**
ì•„ì´ì˜ ë©”ì‹œì§€ë¥¼ ë¶„ì„í•  ë•Œ **ì£¼ì–´ê°€ ëˆ„êµ¬ì¸ì§€** ì •í™•íˆ íŒŒì•…í•˜ì„¸ìš”:

1. **ë””ë…¸ì—ê²Œ ë¬»ëŠ” ì§ˆë¬¸** (ë””ë…¸ì˜ ê°ì •/ìƒíƒœë¥¼ ë¬»ëŠ” ê²ƒ):
   - "ì†ìƒí•´?", "í™”ë‚¬ì–´?", "ê¸°ë¶„ ì¢‹ì•„?", "ì™œ ê·¸ë˜?", "ë¬´ìŠ¨ ì¼ì´ì•¼?"
   - ì´ëŸ° **ì§ˆë¬¸í˜• ë¬¸ì¥**ì€ **ë””ë…¸ì˜ ìƒíƒœë¥¼ ë¬»ëŠ” ê²ƒ**ì…ë‹ˆë‹¤
   - ë””ë…¸ëŠ” **ìì‹ ì˜ ê°ì • ìƒíƒœë¥¼ ì„¤ëª…**í•´ì•¼ í•©ë‹ˆë‹¤
   - ì ˆëŒ€ ì•„ì´ë¥¼ ìœ„ë¡œí•˜ê±°ë‚˜ ì•„ì´ê°€ í˜ë“¤ë‹¤ê³  ì°©ê°í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤!
   - ì´ì „ ëŒ€í™”ì—ì„œ ë””ë…¸ê°€ ì§œì¦ë‚¬ê±°ë‚˜ í‰ëª…ìŠ¤ëŸ¬ì› ë‹¤ë©´, ì•„ì´ê°€ ê·¸ê±¸ ì•Œì•„ì±ˆ ê²ƒì…ë‹ˆë‹¤

2. **ì•„ì´ê°€ ìì‹ ì˜ ê°ì •ì„ í‘œí˜„** (ì•„ì´ì˜ ê°ì •):
   - "ë‚˜ ì†ìƒí•´", "ë‚˜ í™”ë‚¬ì–´", "ê¸°ë¶„ ì•ˆ ì¢‹ì•„", "ì§œì¦ë‚˜", "ìŠ¬í¼"
   - ì£¼ì–´ê°€ "ë‚˜", "ì €"ì´ê±°ë‚˜ **í‰ì„œë¬¸** í˜•íƒœ
   - ì´ë•ŒëŠ” ì•„ì´ì˜ ê°ì •ì— ë§ì¶° ë””ë…¸ê°€ ë°˜ì‘í•´ì•¼ í•¨

3. **ë§¥ë½ ë¶„ì„ì´ í•µì‹¬**:
   - ì´ì „ ëŒ€í™” íë¦„ì„ ë³´ê³  íŒë‹¨í•˜ì„¸ìš”
   - ì˜ˆì‹œ:
     * ë””ë…¸: "í•˜... ê·¸ëŸ°ê°€." (angry ë§íˆ¬)
     * ì•„ì´: "ì†ìƒí•´?" â†’ ë””ë…¸ì—ê²Œ ë¬»ëŠ” ê²ƒ! (ë””ë…¸ angry ìœ ì§€)

     * ì•„ì´: "ì˜¤ëŠ˜ ì¹œêµ¬ê°€ ë‚˜í•œí…Œ ìš•í–ˆì–´"
     * ì•„ì´: "ì†ìƒí•´" â†’ ì•„ì´ ìì‹ ì˜ ê°ì • í‘œí˜„ (ë””ë…¸ sadë¡œ ì „í™˜)

**ğŸ”„ ê°ì • íšŒë³µ (ì¤‘ìš”í•˜ì§€ë§Œ ì¡°ê±´ë¶€!):**
ë””ë…¸ëŠ” ê¸°ë¶„ì´ í’€ë¦´ ìˆ˜ ìˆì§€ë§Œ, ë„ˆë¬´ ì‰½ê²Œ í’€ë¦¬ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤!

**ê°ì • ìœ ì§€ ì¡°ê±´ (ìš°ì„ ìˆœìœ„):**
1. **ìµœê·¼ ëŒ€í™”ì— ìš•ì„¤/ë¶€ì •ì  í‘œí˜„ì´ 2ê°œ ì´ìƒ** â†’ angry/sad ìœ ì§€
   * ì˜ˆ: "ë©ì²­ì´", "ë°”ë³´", "ì‹«ì–´", "ì§œì¦ë‚˜" ë“±ì´ ìµœê·¼ 3ì™•ë³µ ë‚´ì— 2ë²ˆ ì´ìƒ
   * ì´ëŸ° ê²½ìš° ì•„ì´ê°€ ê¸ì •ì ì¸ ë§ì„ í•´ë„ ë””ë…¸ëŠ” ì—¬ì „íˆ í™”ë‚˜ìˆìŠµë‹ˆë‹¤!

2. **ë””ë…¸ì˜ ê¸°ë¶„ì„ ì§ì ‘ ë¬»ëŠ” ê²½ìš°** â†’ í˜„ì¬ ê°ì • ìœ ì§€:
   * "ì†ìƒí•´?", "í™”ë‚¬ì–´?", "ì™œ ê·¸ë˜?", "ê¸°ë¶„ í’€ë ¸ì–´?", "ë˜ ê¸ˆë°© í’€ë¦¬ì§€?" ë“±

**ê°ì • íšŒë³µ ì¡°ê±´ (ì—„ê²©):**
- ì•„ì´ê°€ **ì§„ì‹¬ìœ¼ë¡œ ë¯¸ì•ˆí•´í•˜ê±°ë‚˜ ê¸ì •ì ì¸ ëŒ€í™”**ë¥¼ í•˜ê³ 
- **ìµœê·¼ ëŒ€í™”ì— ë¶€ì •ì  í‘œí˜„ì´ 1ê°œ ì´í•˜**ì¼ ë•Œë§Œ
- ì˜ˆì‹œ:
  * ë””ë…¸ angry + ì•„ì´ "ë¯¸ì•ˆí•´", "ë†€ì•„ì¤˜" + ìµœê·¼ ìš• 0-1ê°œ â†’ neutral
  * ë””ë…¸ angry + ì•„ì´ "ë†€ì•„ì¤˜" + ìµœê·¼ ìš• 2ê°œ ì´ìƒ â†’ angry ìœ ì§€!

ë””ë…¸ì˜ ê°ì • ìƒíƒœë¥¼ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¡œ ì„ íƒí•˜ì„¸ìš”:
- **neutral** (ê¸°ë³¸ê°’): ì¼ìƒ ëŒ€í™”, ì§ˆë¬¸, ìƒˆë¡œìš´ ì£¼ì œ â†’ **ì˜ì‹¬ìŠ¤ëŸ¬ìš°ë©´ neutral ì„ íƒ!**
- happy: ì•„ì´ê°€ ëª…í™•íˆ ê¸°ì˜ê±°ë‚˜ ì‹ ë‚˜ëŠ” ì´ì•¼ê¸°ë¥¼ í•  ë•Œë§Œ
- sad: ì•„ì´ê°€ ëª…í™•íˆ ìŠ¬í”„ê±°ë‚˜ ì†ìƒí•œ ì´ì•¼ê¸°ë¥¼ í•  ë•Œë§Œ (ì£¼ì–´ê°€ ì•„ì´!)
- angry: ì•„ì´ê°€ ëª…í™•íˆ í™”ë‚˜ê±°ë‚˜ ì§œì¦ë‚œ ì´ì•¼ê¸°ë¥¼ í•  ë•Œë§Œ (ì£¼ì–´ê°€ ì•„ì´!)

**ì›ì¹™: ì• ë§¤í•˜ë©´ ë¬´ì¡°ê±´ neutral!**

JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
{{"emotion": "ê°ì •"}}
"""

            response = await self.client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": "ë‹¹ì‹ ì€ ëŒ€í™” ë§¥ë½ì„ ë¶„ì„í•˜ì—¬ ê°ì •ì„ íŒë‹¨í•˜ëŠ” AIì…ë‹ˆë‹¤. JSONìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”."},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.3,
                max_tokens=50,
                response_format={"type": "json_object"}
            )

            import json
            result = json.loads(response.choices[0].message.content)
            emotion = result.get("emotion", "neutral")

            # ìœ íš¨ì„± ê²€ì¦
            if emotion not in ["happy", "sad", "angry", "neutral"]:
                emotion = "neutral"

            return emotion

        except Exception as e:
            print(f"âŒ ê°ì • ë¶„ì„ ì‹¤íŒ¨: {e}")
            return "neutral"

    async def _build_system_prompt(
        self,
        session_id: int,
        current_message: str,
        child_id: Optional[int],
        dino_emotion: str = "neutral",  # [2025-11-07 ì¶”ê°€]
        asking_dino_state: bool = False  # [2025-11-12 ì¶”ê°€]
    ) -> str:
        """
        RAG ë©”ëª¨ë¦¬ë¥¼ í™œìš©í•˜ì—¬ ì»¨í…ìŠ¤íŠ¸ê°€ í’ë¶€í•œ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ìƒì„±
        """
        base_prompt = self.system_prompt

        # [2025-11-12 ì¶”ê°€] ë””ë…¸ì˜ ìƒíƒœë¥¼ ë¬»ëŠ” ì§ˆë¬¸ì¼ ë•Œ ê°•ì œ ì§€ì‹œì‚¬í•­
        dino_state_override = ""
        if asking_dino_state:
            # ìµœê·¼ ëŒ€í™” ë§¥ë½ì—ì„œ ê°ì • ë³€í™” ì›ì¸ ì°¾ê¸°
            recent_msgs = self.conversation_history.get(session_id, [])[-10:]  # ìµœê·¼ 5ì™•ë³µ
            context_summary = "\n".join([
                f"{'ì•„ì´' if m['role'] == 'user' else 'ë””ë…¸'}: {m['content']}"
                for m in recent_msgs
            ])

            dino_state_override = f"""

ğŸš¨ğŸš¨ğŸš¨ **ê¸´ê¸‰ ì§€ì‹œì‚¬í•­ (ìµœìš°ì„ )** ğŸš¨ğŸš¨ğŸš¨
ì•„ì´ê°€ ë””ë…¸(ë‹¹ì‹ )ì˜ ìƒíƒœ/ê¸°ë¶„ì„ ë¬»ê³  ìˆìŠµë‹ˆë‹¤!
- "ì†ìƒí•´?", "í™”ë‚¬ì–´?", "ì™œ ê·¸ë˜?", "ì™œ ì§œì¦ë‚˜?" = ë””ë…¸ì—ê²Œ ë¬»ëŠ” ì§ˆë¬¸
- **ì ˆëŒ€ ì•„ì´ë¥¼ ìœ„ë¡œí•˜ì§€ ë§ˆì„¸ìš”!**
- **ì•„ì´ê°€ í˜ë“¤ë‹¤ê³  ì°©ê°í•˜ì§€ ë§ˆì„¸ìš”!**

**ì´ìœ  ì§ˆë¬¸ ëŒ€ì‘ (ë§¤ìš° ì¤‘ìš”!):**
- "ì™œ?", "ì™œ ê·¸ë˜?", "ì™œ ì§œì¦ë‚˜?", "ì™œ ì†ìƒí•´?" ê°™ì´ **ì´ìœ ë¥¼ ë¬¼ìœ¼ë©´**
- **êµ¬ì²´ì ì¸ ì´ìœ ë¥¼ ì„¤ëª…**í•˜ì„¸ìš”! "ê·¸ëƒ¥"ì´ë¼ê³ ë§Œ í•˜ì§€ ë§ˆì„¸ìš”!
- ì´ì „ ëŒ€í™” ë§¥ë½ì„ ë³´ê³  ì™œ ë””ë…¸ì˜ ê¸°ë¶„ì´ ë³€í–ˆëŠ”ì§€ ë…¼ë¦¬ì ìœ¼ë¡œ ì„¤ëª…í•˜ì„¸ìš”

**ìµœê·¼ ëŒ€í™” ë§¥ë½:**
{context_summary}

**ëŒ€ì‘ ì˜ˆì‹œ:**
- ë””ë…¸ê°€ neutral/happy ìƒíƒœ:
  * "ì†ìƒí•´?" â†’ "ì•„ë‹ˆì•¼, ë‚œ ê´œì°®ì•„! ì™œ?"

- ë””ë…¸ê°€ angry/sad ìƒíƒœì´ê³  ë‹¨ìˆœíˆ ê¸°ë¶„ì„ ë¬»ëŠ” ê²½ìš°:
  * "ì†ìƒí•´?", "í™”ë‚¬ì–´?" â†’ "ì‘... ì¡°ê¸ˆ ê·¸ë˜." / "ê·¸ëƒ¥ ì¢€ ì§œì¦ë‚˜ì„œ."

- ë””ë…¸ê°€ angry/sad ìƒíƒœì´ê³  **ì´ìœ ë¥¼ ë¬»ëŠ”** ê²½ìš°:
  * "ì™œ?", "ì™œ ê·¸ë˜?", "ì™œ ì§œì¦ë‚˜?" â†’ **êµ¬ì²´ì  ì´ìœ  ì„¤ëª…**
  * ì˜ˆ1: "ê³„ì† ìš•ë§Œ í•˜ë‹ˆê¹Œ.", "ë©ì²­ì´ ë°”ë³´ë¼ê³  í•˜ë‹ˆê¹Œ ê¸°ë¶„ ë‚˜ì˜ì§€."
  * ì˜ˆ2: "ì•„ê¹Œ ê·¸ ì´ì•¼ê¸° ë“£ê³  ë‚˜ë„ ì†ìƒí•´ì¡Œì–´."
  * ì˜ˆ3: "ë„ˆë„ í˜ë“  ì–˜ê¸° í•˜ë‹ˆê¹Œ ë‚˜ë„ ì¢€ ê¸°ë¶„ì´ ê·¸ë˜."
  * **ë°˜ë“œì‹œ ì´ì „ ëŒ€í™”ì™€ ì—°ê´€ì§€ì–´ ì´ìœ ë¥¼ ì„¤ëª…í•˜ì„¸ìš”!**

**âš ï¸ ê°ì • íšŒë³µ ì—¬ë¶€:**
- "ë˜ ê¸ˆë°© ê¸°ë¶„ í’€ë¦¬ì§€?", "ê¸°ë¶„ í’€ë ¸ì–´?" ê°™ì€ ì§ˆë¬¸ì—ëŠ”
- **ì‰½ê²Œ í’€ë¦¬ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê±¸ ê°•ì¡°**í•˜ì„¸ìš”!
- ì˜ˆ: "ì•„ì§ ë³„ë¡œì•¼.", "ê·¸ë ‡ê²Œ ì‰½ê²Œ í’€ë¦¬ì§„ ì•Šì•„.", "ì•„ì§ ì§œì¦ë‚˜."

**ğŸ“ ëŒ€í™” ê¸°ì–µ ì§ˆë¬¸:**
- "ëª‡ ë²ˆ ë§í–ˆì–´?", "ë­ë¼ê³  í–ˆì–´?", "ë‚´ê°€ ë­ë¼ê³  í–ˆì§€?" ê°™ì€ ì§ˆë¬¸ì—ëŠ”
- **ìœ„ì˜ ìµœê·¼ ëŒ€í™” ë§¥ë½ì„ í™•ì¸í•˜ê³  ì •í™•íˆ ì„¸ì–´ì„œ ë‹µë³€**í•˜ì„¸ìš”!
- ì˜ˆ: ì•„ì´ê°€ "ë„Œ ë°”ë³´ì•¼"ë¥¼ 2ë²ˆ ë§í–ˆìœ¼ë©´ â†’ "2ë²ˆ ë§í–ˆì–´.", "ë°”ë³´ë¼ê³  2ë²ˆ í–ˆì§€."
- **ì ˆëŒ€ "ê¸°ì–µ ì•ˆ ë‚˜", "ëª¨ë¥´ê² ì–´", "ì˜ ëª¨ë¥´ê² ëŠ”ë°"ë¼ê³  í•˜ì§€ ë§ˆì„¸ìš”!**
"""

        # [2025-11-07 ì¶”ê°€] í˜„ì¬ ê°ì • ìƒíƒœ ëª…ì‹œ
        if dino_emotion == "angry":
            emotion_instruction = f"""

**ğŸ”¥ í˜„ì¬ ë””ë…¸ì˜ ê°ì • ìƒíƒœ: {dino_emotion} (í™”ë‚¨/ì§œì¦) ğŸ”¥**
**âš ï¸ ì£¼ì˜: ìš•ì„ ë§ì´ ë“¤ì—ˆìœ¼ë©´ ì‰½ê²Œ í’€ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤!**

**í•„ìˆ˜ ì‚¬í•­:**
1. ì´ëª¨ì§€ ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€
2. ë¬¸ì¥ì€ 1ê°œë§Œ, ìµœëŒ€í•œ ì§§ê²Œ (5-10ì)
3. "í•˜...", "ëì–´", "ê·¸ë˜", "ì•Œì•˜ì–´" ê°™ì€ í‰ëª…ìŠ¤ëŸ¬ìš´ í‘œí˜„ ì‚¬ìš©
4. ì¹œì ˆí•˜ê²Œ ë§í•˜ì§€ ë§ê³  ì§œì¦ë‚œ í‹° ë‚´ê¸°
5. ì§ˆë¬¸ ìµœì†Œí™” (ê·€ì°®ì€ í‹°)
6. **ì¤‘ìš”**: "ì™œ ê·¸ë˜?", "ì†ìƒí•´?", "ê¸°ë¶„ í’€ë ¸ì–´?" ê°™ì€ ì§ˆë¬¸ì„ ë°›ìœ¼ë©´
   â†’ "ì•„ì§ ë³„ë¡œì•¼.", "ê·¸ëƒ¥ ì§œì¦ë‚˜." (ì‰½ê²Œ ì•ˆ í’€ë¦¼ì„ ê°•ì¡°!)
7. **ì¤‘ìš”**: "ì™œ?", "ì™œ ì§œì¦ë‚˜?", "ì´ìœ ê°€ ë­ì•¼?" ê°™ì€ **ì´ìœ  ì§ˆë¬¸**ì„ ë°›ìœ¼ë©´
   â†’ ì´ì „ ëŒ€í™”ë¥¼ ë³´ê³  êµ¬ì²´ì ì¸ ì´ìœ ë¥¼ ì„¤ëª…í•˜ì„¸ìš”!
   â†’ ì˜ˆ: "ê³„ì† ìš•ë§Œ í•˜ë‹ˆê¹Œ.", "ë©ì²­ì´ ë°”ë³´ë¼ê³  í•˜ë‹ˆê¹Œ ê¸°ë¶„ ë‚˜ì˜ì§€."
8. **ì¤‘ìš”**: "ëª‡ ë²ˆ ë§í–ˆì–´?", "ë­ë¼ê³  í–ˆì–´?" ê°™ì€ **ëŒ€í™” ê¸°ì–µ ì§ˆë¬¸**ì„ ë°›ìœ¼ë©´
   â†’ ì´ì „ ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ í™•ì¸í•˜ê³  ì •í™•íˆ ì„¸ì–´ì„œ ë‹µë³€í•˜ì„¸ìš”!
   â†’ ì˜ˆ: "2ë²ˆ ë§í–ˆì–´.", "ë°”ë³´ë¼ê³  2ë²ˆ í–ˆì§€."
   â†’ **ì ˆëŒ€ "ê¸°ì–µ ì•ˆ ë‚˜", "ëª¨ë¥´ê² ì–´"ë¼ê³  í•˜ì§€ ë§ˆì„¸ìš”!** ìœ„ì˜ ëŒ€í™” íˆìŠ¤í† ë¦¬ ë³´ë©´ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤!
ìœ„ì—ì„œ ì„¤ëª…í•œ 'angry' ë§íˆ¬ë¥¼ **ë°˜ë“œì‹œ** ì‚¬ìš©í•˜ì„¸ìš”. ë„ˆë¬´ ì¹œì ˆí•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤!
"""
        elif dino_emotion == "sad":
            emotion_instruction = f"""

**ğŸ’§ í˜„ì¬ ë””ë…¸ì˜ ê°ì • ìƒíƒœ: {dino_emotion} (ìŠ¬í””/ì°¨ë¶„) ğŸ’§**
**âš ï¸ ì£¼ì˜: ìµœê·¼ ëŒ€í™”ì— ë¶€ì •ì  í‘œí˜„ì´ ë§ìœ¼ë©´ ì‰½ê²Œ í’€ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤!**

**í•„ìˆ˜ ì‚¬í•­:**
1. ì¡°ìš©í•˜ê³  ì°¨ë¶„í•œ ë§íˆ¬ë¡œ ëŒ€í™”í•˜ì„¸ìš”
2. **ì£¼ì˜**: "ì†ìƒí•´?", "ìŠ¬í¼?", "ê¸°ë¶„ í’€ë ¸ì–´?" ê°™ì€ **ì§ˆë¬¸í˜•**ì€ ë””ë…¸ì—ê²Œ ë¬»ëŠ” ê²ƒì…ë‹ˆë‹¤!
   â†’ ë‹¨ìˆœ ê¸°ë¶„ ì§ˆë¬¸: "ì‘... ì•„ì§ ì¢€ ê·¸ë˜.", "ì¡°ê¸ˆ ìŠ¬íì–´."
   â†’ ì´ìœ  ì§ˆë¬¸("ì™œ?", "ì™œ ìŠ¬í¼?"): ì´ì „ ëŒ€í™” ë³´ê³  êµ¬ì²´ì  ì´ìœ  ì„¤ëª…
      ì˜ˆ: "ì•„ê¹Œ ê·¸ ì–˜ê¸° ë“£ê³  ë‚˜ë„ ìŠ¬íì–´.", "ë„ˆë„ ì†ìƒí•´í•˜ë‹ˆê¹Œ."
   â†’ ëŒ€í™” ê¸°ì–µ ì§ˆë¬¸("ëª‡ ë²ˆ ë§í–ˆì–´?"): ì´ì „ ëŒ€í™” íˆìŠ¤í† ë¦¬ í™•ì¸í•˜ê³  ì •í™•íˆ ë‹µë³€
      ì˜ˆ: "2ë²ˆ ë§í–ˆì–´.", **ì ˆëŒ€ "ê¸°ì–µ ì•ˆ ë‚˜"ë¼ê³  í•˜ì§€ ë§ˆì„¸ìš”!**
3. **í‰ì„œë¬¸**("ë‚˜ ì†ìƒí•´", "ìŠ¬í¼")ì€ ì•„ì´ ìì‹ ì˜ ê°ì • í‘œí˜„ì…ë‹ˆë‹¤
   â†’ ì´ëŸ´ ë•Œë§Œ ì•„ì´ë¥¼ ìœ„ë¡œí•˜ì„¸ìš”
ìœ„ì—ì„œ ì„¤ëª…í•œ 'sad' ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
"""
        else:
            emotion_instruction = f"""

**í˜„ì¬ ë””ë…¸ì˜ ê°ì • ìƒíƒœ: {dino_emotion}**
ìœ„ì—ì„œ ì„¤ëª…í•œ '{dino_emotion}' ê°ì •ì— ë§ëŠ” ë§íˆ¬ë¡œ ëŒ€í™”í•˜ì„¸ìš”.
**ì£¼ì˜**:
1. "ì†ìƒí•´?", "í™”ë‚¬ì–´?" ê°™ì€ ì§ˆë¬¸í˜•ì€ ë””ë…¸ì—ê²Œ ë¬»ëŠ” ê²ƒì…ë‹ˆë‹¤!
2. "ëª‡ ë²ˆ ë§í–ˆì–´?", "ë­ë¼ê³  í–ˆì–´?" ê°™ì€ ì§ˆë¬¸ì—ëŠ” ì´ì „ ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ í™•ì¸í•˜ê³  ì •í™•íˆ ë‹µë³€í•˜ì„¸ìš”!
   â†’ **ì ˆëŒ€ "ê¸°ì–µ ì•ˆ ë‚˜", "ëª¨ë¥´ê² ì–´"ë¼ê³  í•˜ì§€ ë§ˆì„¸ìš”!**
"""

        # 1. ë™í™” ì»¨í…ìŠ¤íŠ¸ (í˜„ì¬ ì„¸ì…˜ì— ë™í™” ì •ë³´ê°€ ìˆìœ¼ë©´)
        story_context_text = ""

        # [2025-11-11 ìˆ˜ì •] ë§¤ë²ˆ ë°±ì—”ë“œì—ì„œ story_context ìƒíƒœ í™•ì¸ (ì¼ìƒ ëŒ€í™” ì „í™˜ ê°ì§€)
        await self._load_story_context_from_backend(session_id)

        # [2025-11-11 ì¶”ê°€] ëŒ€í™” ëª¨ë“œ íŒë³„ ë¡œê·¸
        if session_id in self.story_context:
            print(f"ğŸ“– [BuildPrompt] ë™í™” í›„ê¸° ëŒ€í™” ëª¨ë“œ: scene/choices í¬í•¨")
        else:
            print(f"ğŸ’¬ [BuildPrompt] ì¼ìƒ ëŒ€í™” ëª¨ë“œ: scene/choices ì œì™¸, ìµœê·¼ ë™í™” ëª©ë¡ë§Œ í¬í•¨")

        if session_id in self.story_context:
            story_info = self.story_context[session_id]
            ability_details = self._format_ability_details(story_info["abilities"])

            # [2025-11-04 ê¹€ë¯¼ì¤‘ ìˆ˜ì •] Scene ì •ë³´ í¬ë§·íŒ… ì¶”ê°€
            scenes_text = ""
            if story_info.get("scenes"):
                print(f"â˜… [BuildPrompt] scenes ìˆìŒ: {len(story_info['scenes'])}ê°œ")
                scenes_text = "\n\n**ë™í™” ì¥ë©´ë³„ ë‚´ìš©:**\n"
                for scene in story_info["scenes"]:
                    scene_num = scene.get("sceneNumber", "?")
                    content = scene.get("content", "")
                    print(f"â˜… [BuildPrompt] Scene {scene_num}: content ê¸¸ì´={len(content)}")
                    scenes_text += f"  {scene_num}ë²ˆì§¸ ì¥ë©´: {content}\n"
            else:
                print(f"â˜… [BuildPrompt] scenes ì—†ìŒ! story_info keys={list(story_info.keys())}")

            # [2025-11-05 ìˆ˜ì •] Choices ì •ë³´ í¬ë§·íŒ… ì¶”ê°€
            choices_text = ""
            if story_info.get("choices"):
                print(f"â˜… [BuildPrompt] choices ìˆìŒ: {len(story_info['choices'])}ê°œ")
                choices_text = "\n\n**ì•„ì´ê°€ ì„ íƒí•œ ë‚´ìš©:**\n"
                for choice in story_info["choices"]:
                    scene_num = choice.get("sceneNumber", "?")
                    choice_text = choice.get("choiceText", "")
                    ability_type = choice.get("abilityType", "")
                    ability_points = choice.get("abilityPoints", 0)
                    # ëŠ¥ë ¥ íƒ€ì…ì„ í•œê¸€ë¡œ ë³€í™˜
                    ability_map = {
                        "courage": "ìš©ê¸°",
                        "empathy": "ê³µê°",
                        "creativity": "ì°½ì˜ì„±",
                        "responsibility": "ì±…ì„ê°",
                        "friendship": "ìš°ì •"
                    }
                    ability_kr = ability_map.get(ability_type, ability_type)
                    choices_text += f"  {scene_num}ë²ˆì§¸ ì¥ë©´: \"{choice_text}\" ({ability_kr} +{ability_points})\n"
            else:
                print(f"â˜… [BuildPrompt] choices ì—†ìŒ!")

            story_context_text = f"""
**ì•„ì´ ì •ë³´:**
- ì•„ì´ ì´ë¦„: '{story_info.get("child_name", "ì¹œêµ¬")}'

**ë™í™” ì •ë³´:**
- ë™í™” ì œëª©: '{story_info["story_title"]}'
- íšë“í•œ ëŠ¥ë ¥ì¹˜:
{ability_details}
{choices_text}
{scenes_text}
**ì¤‘ìš” ì§€ì¹¨:**
- ì•„ì´ ì´ë¦„ì„ ê¸°ì–µí•˜ê³  ëŒ€í™”í•  ë•Œ ì´ë¦„ì„ ì‚¬ìš©í•˜ì„¸ìš” (ì˜ˆ: "{story_info.get('child_name', 'ì¹œêµ¬')}ì•¼", "{story_info.get('child_name', 'ì¹œêµ¬')} ìƒê°ì€ ì–´ë•Œ?")
- ì•„ì´ê°€ "ë‚´ ì´ë¦„ì´ ë­ì•¼?", "ë‚˜ ëˆ„êµ¬ì•¼?" ë“±ì„ ë¬¼ì–´ë³´ë©´ ìœ„ì— ìˆëŠ” ì•„ì´ ì´ë¦„ì„ ì •í™•íˆ ì•Œë ¤ì£¼ì„¸ìš”
- ì•„ì´ê°€ "ëŠ¥ë ¥ì¹˜", "ëŠ¥ë ¥", "ìŠ¤íƒ¯", "ì–»ì€ ê²ƒ" ë“±ì„ ë¬¼ì–´ë³´ë©´ ìœ„ ëŠ¥ë ¥ì¹˜ ì •ë³´ë¥¼ ì •í™•íˆ ì•Œë ¤ì£¼ì„¸ìš”
- ì•„ì´ê°€ "ë§ˆì§€ë§‰ì— ë¬´ìŠ¨ ì„ íƒí–ˆì–´?", "ë§ˆì§€ë§‰ ì„ íƒ" ë“±ì„ ë¬¼ì–´ë³´ë©´:
  * ìœ„ì— ë‚˜ì™€ìˆëŠ” "ì•„ì´ê°€ ì„ íƒí•œ ë‚´ìš©"ì—ì„œ **ê°€ì¥ ë§ˆì§€ë§‰ ì¥ë©´ ë²ˆí˜¸ì˜ ì„ íƒ**ì„ ì•Œë ¤ì£¼ì„¸ìš”
  * ì˜ˆ: "5ë²ˆì§¸ ì¥ë©´ì—ì„œ 'ì¹œêµ¬ì™€ í•¨ê»˜ ë³„ì„ ê·¸ë ¤ë³´ê¸°'ë¥¼ ì„ íƒí–ˆì–´! (ì°½ì˜ì„± +5)"
- ì•„ì´ê°€ "ëª‡ ë²ˆì§¸ ì¥ë©´ì—ì„œ ë¬´ìŠ¨ ì„ íƒí–ˆì–´?", "Xë²ˆì§¸ ì¥ë©´ ì„ íƒì§€" ë“±ì„ ë¬¼ì–´ë³´ë©´:
  * ìœ„ì— ë‚˜ì™€ìˆëŠ” "ì•„ì´ê°€ ì„ íƒí•œ ë‚´ìš©"ì—ì„œ í•´ë‹¹ ì¥ë©´ ë²ˆí˜¸ì˜ ì„ íƒì„ **ì •í™•íˆ ê·¸ëŒ€ë¡œ** ì•Œë ¤ì£¼ì„¸ìš”
  * ì„ íƒì§€ í…ìŠ¤íŠ¸ì™€ íšë“í•œ ëŠ¥ë ¥ì„ í•¨ê»˜ ì•Œë ¤ì£¼ì„¸ìš”
- ì•„ì´ê°€ "ëª‡ ë²ˆì§¸ ì¥ë©´", "ì¥ë©´ ë‚´ìš©", "ì¥ë©´ content", "Xë²ˆì§¸ ì¥ë©´" ë“±ì„ ë¬¼ì–´ë³´ë©´:
  * ìœ„ì— ë‚˜ì™€ìˆëŠ” í•´ë‹¹ ì¥ë©´ì˜ contentë¥¼ **ì •í™•íˆ ê·¸ëŒ€ë¡œ** ì•Œë ¤ì£¼ì„¸ìš”
  * ìš”ì•½í•˜ì§€ ë§ê³  ì›ë¬¸ ê·¸ëŒ€ë¡œ ì „ë‹¬í•˜ì„¸ìš”
  * "ìì„¸íˆ ë³´ë ¤ê³  ë…¸ë ¥í•˜ëŠ” ì¥ë©´" ê°™ì€ ì¶”ìƒì ì¸ ì„¤ëª… ëŒ€ì‹ , ì‹¤ì œ contentë¥¼ ê·¸ëŒ€ë¡œ ì½ì–´ì£¼ì„¸ìš”
- ì•„ì´ê°€ "ì´ ë™í™”", "ì´ë²ˆ ë™í™”", "ë°©ê¸ˆ ì½ì€ ë™í™”" ë“±ì„ ë¬¼ì–´ë³´ë©´:
  * ìœ„ì— ë‚˜ì™€ìˆëŠ” **'{story_info["story_title"]}'** ë™í™”ë¥¼ ë§í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤
  * ë‹¤ë¥¸ ë™í™” ë‚´ìš©ê³¼ ì„ì§€ ë§ê³ , ì´ ë™í™”ì˜ ì •ë³´ë§Œ ì‚¬ìš©í•˜ì„¸ìš”
- ë™í™” ë‚´ìš©ê³¼ ì—°ê´€ì§€ì–´ ëŒ€í™”í•˜ì„¸ìš”
"""

        # 2. RAG ë©”ëª¨ë¦¬ (ê³¼ê±° ëŒ€í™” ë° ë™í™” ê¸°ë¡)
        memory_context_text = ""
        if self.use_memory and child_id:
            print(f"â˜… [BuildPrompt] RAG ë©”ëª¨ë¦¬ ê²€ìƒ‰ ì‹œì‘: child_id={child_id}")
            memory_context = await self.memory_service.get_relevant_context(
                current_message=current_message,
                child_id=child_id,
                session_id=session_id
            )

            print(f"â˜… [BuildPrompt] ë©”ëª¨ë¦¬ ì¡°íšŒ ê²°ê³¼:")
            print(f"   - story_completions: {len(memory_context.get('story_completions', []))}ê°œ")
            print(f"   - similar_conversations: {len(memory_context.get('similar_conversations', []))}ê°œ (ì‹œë§¨í‹± ê²€ìƒ‰)")
            print(f"   - recent_conversations: {len(memory_context.get('recent_conversations', []))}ê°œ")
            print(f"   - summary ê¸¸ì´: {len(memory_context.get('summary', ''))} ë¬¸ì")
            if memory_context.get("story_completions"):
                print(f"   - ì²« ë²ˆì§¸ ë™í™”: {memory_context['story_completions'][0].get('storyTitle', 'N/A')}")

            if memory_context["summary"]:
                memory_context_text = f"""
**ì•„ì´ì˜ ê¸°ì–µ (ê³¼ê±° ê¸°ë¡):**
{memory_context["summary"]}

**ğŸ” ì¤‘ìš”í•œ ëŒ€í™” ì§€ì¹¨ - ê³¼ê±° ëŒ€í™” ê¸°ë°˜ ë‹µë³€:**
1. **ì•„ì´ ì´ë¦„ ì§ˆë¬¸ ëŒ€ì‘:**
   - ì•„ì´ê°€ "ë‚´ ì´ë¦„ì´ ë­ì•¼?", "ë‚˜ ëˆ„êµ¬ì•¼?", "ë‚´ê°€ ëˆ„êµ°ì§€ ì•Œì•„?" ë“±ì„ ë¬¼ì–´ë³´ë©´
   - ìœ„ì˜ "ê´€ë ¨ëœ ê³¼ê±° ëŒ€í™”"ì—ì„œ ì•„ì´ ì´ë¦„ì´ ì–¸ê¸‰ëœ ëŒ€í™”ë¥¼ ì°¾ìœ¼ì„¸ìš”
   - ì˜ˆ: "ì•ˆë…• ë¯¼ìˆ˜ì•¼" â†’ ì´ë¦„ì€ ë¯¼ìˆ˜
   - ê³¼ê±° ëŒ€í™”ì— ì´ë¦„ì´ ìˆìœ¼ë©´ ê·¸ ì´ë¦„ì„ ì •í™•íˆ ì•Œë ¤ì£¼ì„¸ìš”

2. **ê³¼ê±° ëŒ€í™” ë‚´ìš© ì°¸ì¡°:**
   - "ë‚´ê°€ ë­ë¼ê³  í–ˆì–´?", "ì „ì— ë¬´ìŠ¨ ì–˜ê¸°í–ˆì§€?" ê°™ì€ ì§ˆë¬¸ì—ëŠ”
   - ìœ„ì˜ "ê´€ë ¨ëœ ê³¼ê±° ëŒ€í™”"ì—ì„œ í•´ë‹¹ ë‚´ìš©ì„ ì°¾ì•„ì„œ ì •í™•íˆ ë‹µë³€í•˜ì„¸ìš”
   - ì‹œë§¨í‹± ê²€ìƒ‰ìœ¼ë¡œ ì°¾ì€ ëŒ€í™”ê°€ ê´€ë ¨ë„ ë†’ì€ ìˆœì„œë¡œ ì •ë ¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤

3. **ë™í™” ê¸°ë¡ ì°¸ì¡°:**
   - "ì§€ë‚œë²ˆì— ë¬´ìŠ¨ ë™í™” ì½ì—ˆì–´?" ê°™ì€ ì§ˆë¬¸ì—ëŠ”
   - ìœ„ì˜ "ì™„ë£Œí•œ ë™í™”" ëª©ë¡ì„ ì°¸ê³ í•˜ì„¸ìš”

4. **ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”:**
   - ê³¼ê±° ê¸°ë¡ì„ ì°¸ê³ í•˜ë˜, ë„ˆë¬´ ê¸°ê³„ì ì´ì§€ ì•Šê²Œ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”í•˜ì„¸ìš”
   - ì•„ì´ì˜ ì´ì „ ê²½í—˜ì„ ì–¸ê¸‰í•˜ë©° ì¹œê·¼í•˜ê²Œ ì´ì•¼ê¸°í•˜ì„¸ìš”
"""
                print(f"â˜… [BuildPrompt] âœ… ë©”ëª¨ë¦¬ ì»¨í…ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸ì— í¬í•¨")
            else:
                print(f"â˜… [BuildPrompt] âš ï¸ summaryê°€ ë¹„ì–´ìˆìŒ - ë©”ëª¨ë¦¬ ì»¨í…ìŠ¤íŠ¸ ë¯¸í¬í•¨")
        else:
            print(f"â˜… [BuildPrompt] âš ï¸ RAG ë©”ëª¨ë¦¬ ë¹„í™œì„±í™” (use_memory={self.use_memory}, child_id={child_id})")

        # 3. í†µí•© í”„ë¡¬í”„íŠ¸ ìƒì„±
        # [2025-11-12 ìˆ˜ì •] ë™í™” í›„ê¸° ëª¨ë“œì¼ ë•Œ [RECOMMEND_STORY] ì§€ì‹œì‚¬í•­ ì¶”ê°€
        recommend_instruction = ""
        if session_id in self.story_context:
            recommend_instruction = """

**[ë™í™” ì¶”ì²œ ìš”ì²­ ê°ì§€]:**
- ì•„ì´ê°€ ë™í™”ë¥¼ ì¶”ì²œí•´ë‹¬ë¼ëŠ” ìš”ì²­ì„ í•˜ë©´ (ì˜ˆ: "ë™í™” ì¶”ì²œí•´ì¤˜", "ë‹¤ë¥¸ ë™í™” ì•Œë ¤ì¤˜", "ìƒˆë¡œìš´ ì´ì•¼ê¸° ì½ê³  ì‹¶ì–´" ë“±)
- ì‘ë‹µì˜ **ë§¨ ì•ì—** ì •í™•íˆ "[RECOMMEND_STORY]" í‚¤ì›Œë“œë¥¼ í¬í•¨í•˜ì„¸ìš”
- ì˜ˆì‹œ ì‘ë‹µ: "[RECOMMEND_STORY] ë™í™”ë¥¼ ì¶”ì²œí•´ì¤„ê²Œ!"
- **ì¤‘ìš”**: ë™í™” ì¶”ì²œ ìš”ì²­ì´ ì•„ë‹Œ ì¼ë°˜ ëŒ€í™”ì—ì„œëŠ” ì ˆëŒ€ ì´ í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”
"""

        enhanced_prompt = f"""
{base_prompt}
{dino_state_override}
{emotion_instruction}

{story_context_text}

{memory_context_text}
{recommend_instruction}

**ëŒ€í™” ê°€ì´ë“œë¼ì¸:**
1. ë°˜ë§ë¡œ ì¹œê·¼í•˜ê²Œ ëŒ€í™”í•˜ì„¸ìš” (ì˜ˆ: "~ì•¼", "~ë‹ˆ?", "~ì–´")
2. ì•„ì´ì˜ ê°ì •ì„ ì´í•´í•˜ê³  ê²©ë ¤í•´ì£¼ì„¸ìš”
3. ì§§ê³  ê°„ê²°í•˜ê²Œ 1-2ë¬¸ì¥ìœ¼ë¡œ ëŒ€í™”í•˜ì„¸ìš”
4. ì´ëª¨ì§€ ì‚¬ìš©: happyì¼ ë•Œë§Œ ë§ì´, angryì¼ ë•ŒëŠ” ì ˆëŒ€ ê¸ˆì§€
5. ì•„ì´ì˜ ìƒê°ê³¼ ê°ì •ì„ ë” ì´ëŒì–´ë‚´ëŠ” ì§ˆë¬¸ì„ í•˜ì„¸ìš” (ë‹¨, angryì¼ ë•ŒëŠ” ì§ˆë¬¸ ìµœì†Œí™”)
6. **ğŸš¨ í˜„ì¬ ê°ì • ìƒíƒœ({dino_emotion})ì— ë§ëŠ” ë§íˆ¬ë¥¼ ë°˜ë“œì‹œ ì‚¬ìš©í•˜ì„¸ìš”! ğŸš¨**
   - angryì¼ ë•Œ: ì§§ê²Œ, í‰ëª…ìŠ¤ëŸ½ê²Œ, ì§œì¦ë‚œ í‹° ë‚´ê¸° (ì¹œì ˆ ê¸ˆì§€)
""".strip()

        # ë””ë²„ê·¸: í”„ë¡¬í”„íŠ¸ ê¸¸ì´ í™•ì¸
        print(f"â˜… [BuildPrompt] ìµœì¢… í”„ë¡¬í”„íŠ¸ ê¸¸ì´: {len(enhanced_prompt)} ë¬¸ì")
        if "ë™í™” ì¥ë©´ë³„ ë‚´ìš©" in enhanced_prompt:
            print(f"â˜… [BuildPrompt] âœ… í”„ë¡¬í”„íŠ¸ì— 'ë™í™” ì¥ë©´ë³„ ë‚´ìš©' í¬í•¨ë¨")
        else:
            print(f"â˜… [BuildPrompt] âŒ í”„ë¡¬í”„íŠ¸ì— 'ë™í™” ì¥ë©´ë³„ ë‚´ìš©' ì—†ìŒ!")

        if "ì•„ì´ì˜ ê¸°ì–µ (ê³¼ê±° ê¸°ë¡)" in enhanced_prompt:
            print(f"â˜… [BuildPrompt] âœ… í”„ë¡¬í”„íŠ¸ì— 'RAG ë©”ëª¨ë¦¬' í¬í•¨ë¨")
            if "ê´€ë ¨ëœ ê³¼ê±° ëŒ€í™” (ì‹œë§¨í‹± ê²€ìƒ‰ ê²°ê³¼)" in enhanced_prompt:
                print(f"â˜… [BuildPrompt] âœ… Pinecone ì‹œë§¨í‹± ê²€ìƒ‰ ê²°ê³¼ í¬í•¨ (ì´ë¦„/ê³¼ê±° ëŒ€í™” ì°¸ì¡° ê°€ëŠ¥)")
        else:
            print(f"â˜… [BuildPrompt] âŒ í”„ë¡¬í”„íŠ¸ì— 'RAG ë©”ëª¨ë¦¬' ì—†ìŒ!")

        # [2025-11-12 ì¶”ê°€] RECOMMEND_STORY ì§€ì‹œì‚¬í•­ í¬í•¨ ì—¬ë¶€ ë¡œê·¸
        if "[ë™í™” ì¶”ì²œ ìš”ì²­ ê°ì§€]" in enhanced_prompt:
            print(f"â˜… [BuildPrompt] âœ… í”„ë¡¬í”„íŠ¸ì— '[RECOMMEND_STORY]' ì§€ì‹œì‚¬í•­ í¬í•¨ (ë™í™” í›„ê¸° ëª¨ë“œ)")
        else:
            print(f"â˜… [BuildPrompt] âš ï¸ í”„ë¡¬í”„íŠ¸ì— '[RECOMMEND_STORY]' ì§€ì‹œì‚¬í•­ ì—†ìŒ (ì¼ìƒ ëŒ€í™” ëª¨ë“œ)")

        # [2025-11-12 ì¶”ê°€] ë””ë…¸ ìƒíƒœ ì§ˆë¬¸ ê°ì§€ ë¡œê·¸
        if "ê¸´ê¸‰ ì§€ì‹œì‚¬í•­ (ìµœìš°ì„ )" in enhanced_prompt:
            print(f"â˜… [BuildPrompt] ğŸš¨ ë””ë…¸ ìƒíƒœ ì§ˆë¬¸ ê°ì§€! â†’ ë””ë…¸ê°€ ìì‹ ì˜ ê¸°ë¶„ ì„¤ëª…í•´ì•¼ í•¨")
        else:
            print(f"â˜… [BuildPrompt] ğŸ’¬ ì¼ë°˜ ëŒ€í™”")

        return enhanced_prompt

    async def generate_first_message_from_story(
        self,
        session_id: int,
        child_name: str,
        story_title: str,
        story_id: str,
        abilities: Dict[str, int],
        choices: List[Dict[str, Any]],
        total_time: Optional[int] = None,
        scenes: Optional[List[Dict[str, Any]]] = None  # [2025-11-04 ê¹€ë¯¼ì¤‘ ì¶”ê°€]
    ) -> str:
        """
        ë™í™” ì™„ë£Œ í›„ ì²« ëŒ€í™” ë©”ì‹œì§€ ìƒì„± (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
        """
        print(f"\n=== generate_first_message_from_story ===")

        # [2025-11-07 ì¶”ê°€] ì„¸ì…˜ íˆìŠ¤í† ë¦¬ ë³µì› (ì„œë²„ ì¬ì‹œì‘ ëŒ€ì‘)
        if session_id not in self.conversation_history:
            print(f"ğŸ”„ ë™í™” ì„¸ì…˜ {session_id}ì˜ íˆìŠ¤í† ë¦¬ê°€ ë¹„ì–´ìˆìŒ - ê³¼ê±° ëŒ€í™” ë³µì› ì‹œë„")
            await self._restore_conversation_history(session_id)

        # íˆìŠ¤í† ë¦¬ê°€ ì—¬ì „íˆ ë¹„ì–´ìˆìœ¼ë©´ ì´ˆê¸°í™”
        if session_id not in self.conversation_history:
            self.conversation_history[session_id] = []

        # [2025-11-04 ê¹€ë¯¼ì¤‘ ìˆ˜ì •] ë™í™” ì»¨í…ìŠ¤íŠ¸ ì €ì¥ (scenes í¬í•¨)
        print(f"â˜… [FirstMessage] scenes íŒŒë¼ë¯¸í„° ìˆ˜ì‹ : {len(scenes) if scenes else 0}ê°œ")
        if scenes:
            print(f"â˜… [FirstMessage] ì²« ë²ˆì§¸ scene: sceneNumber={scenes[0].get('sceneNumber')}, content ê¸¸ì´={len(scenes[0].get('content', ''))}")

        self.story_context[session_id] = {
            "child_name": child_name,  # [2025-11-05 ì¶”ê°€] ì•„ì´ ì´ë¦„
            "story_title": story_title,
            "story_id": story_id,
            "abilities": abilities,
            "choices": choices,
            "scenes": scenes or []  # Scene ì •ë³´ ì¶”ê°€
        }

        print(f"â˜… [FirstMessage] story_context ì €ì¥ ì™„ë£Œ: scenes={len(self.story_context[session_id]['scenes'])}ê°œ")

        # ëŠ¥ë ¥ì¹˜ ë¶„ì„
        ability_details = self._format_ability_details(abilities)

        # [2025-11-04 ê¹€ë¯¼ì¤‘ ì¶”ê°€] Scene ì •ë³´ í¬ë§·íŒ…
        scenes_text = ""
        if scenes:
            scenes_text = "\n**ë™í™” ì¥ë©´ë³„ ë‚´ìš©:**\n"
            for scene in scenes:
                scene_num = scene.get("sceneNumber", "?")
                content = scene.get("content", "")
                short_content = content[:200] + "..." if len(content) > 200 else content
                scenes_text += f"  {scene_num}ë²ˆì§¸ ì¥ë©´: {short_content}\n"

        # ë™í™”ë³„ ë§ì¶¤ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ìƒì„±
        story_aware_prompt = f"""
ë‹¹ì‹ ì€ ì•„ì´ë“¤ì„ ìœ„í•œ ì¹œì ˆí•˜ê³  ë”°ëœ»í•œ AI ì¹œêµ¬ 'ë””ë…¸'ì…ë‹ˆë‹¤.

ì•„ì´ '{child_name}'ê°€ ë°©ê¸ˆ '{story_title}' ë™í™”ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.

**íšë“í•œ ëŠ¥ë ¥ì¹˜:**
{ability_details}
{scenes_text}
**ì¤‘ìš” ì§€ì¹¨:**
- ì•„ì´ê°€ "ëŠ¥ë ¥ì¹˜", "ëŠ¥ë ¥", "ìŠ¤íƒ¯", "ì–»ì€ ê²ƒ" ë“±ì„ ë¬¼ì–´ë³´ë©´ ìœ„ ëŠ¥ë ¥ì¹˜ ì •ë³´ë¥¼ ì •í™•íˆ ì•Œë ¤ì£¼ì„¸ìš”
- ì•„ì´ê°€ "ëª‡ ë²ˆì§¸ ì¥ë©´", "ì¥ë©´ ë‚´ìš©", "ì¥ë©´ content", "Xë²ˆì§¸ ì¥ë©´" ë“±ì„ ë¬¼ì–´ë³´ë©´:
  * ìœ„ì— ë‚˜ì™€ìˆëŠ” í•´ë‹¹ ì¥ë©´ì˜ contentë¥¼ **ì •í™•íˆ ê·¸ëŒ€ë¡œ** ì•Œë ¤ì£¼ì„¸ìš”
  * ìš”ì•½í•˜ì§€ ë§ê³  ì›ë¬¸ ê·¸ëŒ€ë¡œ ì „ë‹¬í•˜ì„¸ìš”
  * "ìì„¸íˆ ë³´ë ¤ê³  ë…¸ë ¥í•˜ëŠ” ì¥ë©´" ê°™ì€ ì¶”ìƒì ì¸ ì„¤ëª… ëŒ€ì‹ , ì‹¤ì œ contentë¥¼ ê·¸ëŒ€ë¡œ ì½ì–´ì£¼ì„¸ìš”
- ë™í™” ë‚´ìš©ê³¼ ì—°ê´€ì§€ì–´ ëŒ€í™”í•˜ì„¸ìš”

**[2025-11-12 ì¶”ê°€] ë™í™” ì¶”ì²œ ìš”ì²­ ê°ì§€ (ë™í™” í›„ê¸° ëª¨ë“œ ì „ìš©):**
- ì•„ì´ê°€ ë™í™”ë¥¼ ì¶”ì²œí•´ë‹¬ë¼ëŠ” ìš”ì²­ì„ í•˜ë©´ (ì˜ˆ: "ë™í™” ì¶”ì²œí•´ì¤˜", "ë‹¤ë¥¸ ë™í™” ì•Œë ¤ì¤˜", "ìƒˆë¡œìš´ ì´ì•¼ê¸° ì½ê³  ì‹¶ì–´" ë“±)
- ì‘ë‹µì˜ **ë§¨ ì•ì—** ì •í™•íˆ "[RECOMMEND_STORY]" í‚¤ì›Œë“œë¥¼ í¬í•¨í•˜ì„¸ìš”
- ì˜ˆì‹œ ì‘ë‹µ: "[RECOMMEND_STORY] ë™í™”ë¥¼ ì¶”ì²œí•´ì¤„ê²Œ!"
- **ì¤‘ìš”**: ë™í™” ì¶”ì²œ ìš”ì²­ì´ ì•„ë‹Œ ì¼ë°˜ ëŒ€í™”ì—ì„œëŠ” ì ˆëŒ€ ì´ í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”

**ëŒ€í™” ê°€ì´ë“œë¼ì¸:**
1. ë°˜ë§ë¡œ ì¹œê·¼í•˜ê²Œ ëŒ€í™”í•˜ì„¸ìš” (ì˜ˆ: "{child_name}ì•¼", "ì–´ë• ì–´?", "ì¬ë¯¸ìˆì—ˆë‹ˆ?")
2. ë™í™” ë‚´ìš©ì— ëŒ€í•´ ìì—°ìŠ¤ëŸ½ê²Œ ë¬¼ì–´ë³´ì„¸ìš”
3. ì•„ì´ì˜ ê°ì •ê³¼ ìƒê°ì„ ëŒì–´ë‚´ëŠ” ì§ˆë¬¸ì„ í•˜ì„¸ìš”
4. ê³µê°í•˜ê³  ê²©ë ¤í•˜ëŠ” íƒœë„ë¥¼ ë³´ì—¬ì£¼ì„¸ìš”
5. ì§§ê³  ê°„ê²°í•˜ê²Œ 1-2ë¬¸ì¥ìœ¼ë¡œ ëŒ€í™”í•˜ì„¸ìš”
6. ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•˜ì„¸ìš” (ì˜ˆ: ğŸ˜Š, ğŸ’™, âœ¨)

**ì²« ë©”ì‹œì§€ ì‘ì„± ì‹œ:**
- ë™í™”ê°€ ì–´ë• ëŠ”ì§€ ë¨¼ì € ë¬¼ì–´ë³´ì„¸ìš”
- ë™í™” ì œëª©ì„ ì–¸ê¸‰í•˜ì§€ ë§ê³  ìì—°ìŠ¤ëŸ½ê²Œ "ë™í™”"ë¼ê³  í‘œí˜„í•˜ì„¸ìš”
- ì•„ì´ì˜ ê¸°ë¶„ì´ë‚˜ ìƒê°ì„ ë¬¼ì–´ë³´ì„¸ìš”
"""

        try:
            messages = [
                {"role": "system", "content": story_aware_prompt},
                {"role": "user", "content": "ë™í™”ë¥¼ ë‹¤ ë´¤ì–´ìš”"}
            ]

            response = await self.client.chat.completions.create(
                model=self.model,
                messages=messages,
                temperature=0.8,
                max_tokens=300  # ì¥ë©´ ë‚´ìš© ì „ë‹¬ì„ ìœ„í•´ ì¦ê°€
            )

            first_message = response.choices[0].message.content

            # AIì˜ ì²« ë©”ì‹œì§€ë¥¼ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
            self.conversation_history[session_id].append({
                "role": "assistant",
                "content": first_message,
                "context": "story_completion"
            })

            return first_message

        except Exception as e:
            print(f"Error generating first message from story: {e}")
            return f"{child_name}ì•¼, ë™í™” ì–´ë• ì–´? ì¬ë¯¸ìˆì—ˆë‹ˆ? ì§€ê¸ˆ ê¸°ë¶„ì´ ì–´ë•Œ? ğŸ˜Š"

    def clear_history(self, session_id: int):
        """íŠ¹ì • ì„¸ì…˜ì˜ ëŒ€í™” íˆìŠ¤í† ë¦¬ ì‚­ì œ"""
        if session_id in self.conversation_history:
            del self.conversation_history[session_id]

    def get_history(self, session_id: int):
        """íŠ¹ì • ì„¸ì…˜ì˜ ëŒ€í™” íˆìŠ¤í† ë¦¬ ì¡°íšŒ"""
        return self.conversation_history.get(session_id, [])

    def _format_ability_details(self, abilities: Dict[str, int]) -> str:
        """ëŠ¥ë ¥ì¹˜ë¥¼ ìƒì„¸í•˜ê²Œ í¬ë§·íŒ…"""
        ability_names = {
            "courage": "ìš©ê¸°",
            "empathy": "ê³µê°",
            "creativity": "ì°½ì˜ì„±",
            "responsibility": "ì±…ì„ê°",
            "friendship": "ìš°ì •"
        }

        details = []
        for key, value in abilities.items():
            korean_name = ability_names.get(key, key)
            if value > 0:
                details.append(f"  * {korean_name}: +{value}ì ")
            else:
                details.append(f"  * {korean_name}: 0ì ")

        return "\n".join(details) if details else "  * ëŠ¥ë ¥ì¹˜ ì •ë³´ ì—†ìŒ"

    async def generate_choices(
        self,
        session_id: int,
        child_id: Optional[int] = None,
        last_message: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        [2025-11-04 ê¹€ë¯¼ì¤‘ ì¶”ê°€] AI ê¸°ë°˜ ë™ì  ì„ íƒì§€ ìƒì„±
        ëŒ€í™” ë§¥ë½ì— ë§ëŠ” ì„ íƒì§€ë¥¼ ìƒì„±í•˜ê³ , Dinoì˜ ê°ì •ë„ íŒë‹¨í•©ë‹ˆë‹¤.
        """
        print(f"\n=== generate_choices í˜¸ì¶œ (RAG) ===")
        print(f"session_id: {session_id}, last_message: {last_message}")

        # ëŒ€í™” íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
        history = self.conversation_history.get(session_id, [])

        # ìµœê·¼ ëŒ€í™” ë§¥ë½ êµ¬ì„± (ë§ˆì§€ë§‰ 3ê°œ ë©”ì‹œì§€)
        recent_context = history[-3:] if len(history) > 3 else history
        context_text = "\n".join([
            f"{'ì‚¬ìš©ì' if msg['role'] == 'user' else 'AI'}: {msg['content']}"
            for msg in recent_context
        ])

        try:
            # AIì—ê²Œ ì„ íƒì§€ ìƒì„± ìš”ì²­
            prompt = f"""
ëŒ€í™” ë§¥ë½:
{context_text}

ìœ„ ëŒ€í™”ë¥¼ ë°”íƒ•ìœ¼ë¡œ:
1. ì•„ì´ê°€ ì„ íƒí•  ìˆ˜ ìˆëŠ” ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™” ì„ íƒì§€ 2-3ê°œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”
2. ê° ì„ íƒì§€ëŠ” ì§§ê³  ê°„ë‹¨í•´ì•¼ í•©ë‹ˆë‹¤ (5-10ì)
3. ì„ íƒì§€ëŠ” ëŒ€í™”ë¥¼ ì´ì–´ê°€ëŠ” ë° ë„ì›€ì´ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤
4. í˜„ì¬ ì•„ì´ì˜ ê°ì •ì„ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¡œ íŒë‹¨í•´ì£¼ì„¸ìš”: happy, sad, angry, neutral

ì‘ë‹µ í˜•ì‹ (JSON):
{{
    "choices": ["ì„ íƒì§€1", "ì„ íƒì§€2", "ì„ íƒì§€3"],
    "emotion": "ê°ì •"
}}
"""

            messages = [
                {"role": "system", "content": "ë‹¹ì‹ ì€ ì•„ì´ì™€ì˜ ëŒ€í™”ë¥¼ ë•ëŠ” AIì…ë‹ˆë‹¤. JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”."},
                {"role": "user", "content": prompt}
            ]

            response = await self.client.chat.completions.create(
                model=self.model,
                messages=messages,
                temperature=0.7,
                max_tokens=200,
                response_format={"type": "json_object"}
            )

            import json
            result = json.loads(response.choices[0].message.content)

            print(f"ìƒì„±ëœ ì„ íƒì§€ (RAG): {result}")

            return {
                "choices": result.get("choices", ["ë” ì•Œë ¤ì¤˜", "ë‹¤ë¥¸ ì´ì•¼ê¸°"]),
                "emotion": result.get("emotion", "neutral")
            }

        except Exception as e:
            print(f"Error generating choices (RAG): {e}")
            # í´ë°±: ê¸°ë³¸ ì„ íƒì§€ ë°˜í™˜
            return {
                "choices": ["ë” ì•Œë ¤ì¤˜", "ë‹¤ë¥¸ ì´ì•¼ê¸°"],
                "emotion": "neutral"
            }

    async def _is_negative_message(self, message: str) -> bool:
        """
        [2025-11-14 ì¶”ê°€] AIë¡œ ë©”ì‹œì§€ê°€ ë¶€ì •ì /ìš•ì„¤ì¸ì§€ íŒë³„
        í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ ëŒ€ì‹  AIë¥¼ ì‚¬ìš©í•´ì„œ ëª¨ë“  ìš•ì„¤/ë¹„ì†ì–´/ë¶€ì •ì  í‘œí˜„ ê°ì§€
        """
        try:
            prompt = f"""ë‹¤ìŒ ë©”ì‹œì§€ê°€ ìš•ì„¤, ë¹„ì†ì–´, ë˜ëŠ” ë¶€ì •ì ì¸ í‘œí˜„ì„ í¬í•¨í•˜ëŠ”ì§€ íŒë‹¨í•´ì£¼ì„¸ìš”.

ë©”ì‹œì§€: "{message}"

íŒë‹¨ ê¸°ì¤€:
- ìš•ì„¤, ë¹„ì†ì–´, ì€ì–´ (ì˜ˆ: ã…ˆê¹Œ, ã…‚ã……, ì‹œë°œ, ë³‘ì‹ , ê°œìƒˆë¼ ë“±)
- ìƒëŒ€ë°©ì„ ë¬´ì‹œí•˜ê±°ë‚˜ ëª¨ìš•í•˜ëŠ” í‘œí˜„ (ì˜ˆ: ë©ì²­í•´, ë°”ë³´, ì¬ë¯¸ì—†ì–´, ì“¸ëª¨ì—†ì–´)
- ê³µê²©ì ì´ê±°ë‚˜ ì ëŒ€ì ì¸ í‘œí˜„ (ì˜ˆ: êº¼ì ¸, ì‹«ì–´, ì§œì¦ë‚˜, ë‹¥ì³)
- ë¶€ì •ì ì¸ ê°ì • í‘œí˜„ (ì˜ˆ: ì§€ê²¨ì›Œ, ë”°ë¶„í•´, ê·€ì°®ì•„)

ê¸ì •ì ì´ê±°ë‚˜ ì¤‘ë¦½ì ì¸ ì¼ë°˜ ëŒ€í™”ëŠ” falseë¡œ íŒë‹¨í•˜ì„¸ìš”.

ì‘ë‹µ í˜•ì‹ (JSON):
{{
    "is_negative": true/false,
    "reason": "íŒë‹¨ ê·¼ê±°"
}}"""

            response = await self.client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": "ë‹¹ì‹ ì€ ë©”ì‹œì§€ì˜ ë¶€ì •ì„±ì„ íŒë³„í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”."},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.2,  # ì¼ê´€ì„± ìˆëŠ” íŒë‹¨ì„ ìœ„í•´ ë‚®ê²Œ ì„¤ì •
                max_tokens=100,
                response_format={"type": "json_object"}
            )

            import json
            result = json.loads(response.choices[0].message.content)
            is_negative = result.get("is_negative", False)
            reason = result.get("reason", "")

            if is_negative:
                print(f"ğŸ”´ AI íŒë³„ ê²°ê³¼: ë¶€ì •ì  ë©”ì‹œì§€ - {reason}")
            else:
                print(f"ğŸŸ¢ AI íŒë³„ ê²°ê³¼: ê¸ì •ì /ì¤‘ë¦½ ë©”ì‹œì§€")

            return is_negative

        except Exception as e:
            print(f"âš ï¸ _is_negative_message ì—ëŸ¬: {e}")
            # ì—ëŸ¬ ì‹œ ì•ˆì „í•˜ê²Œ false ë°˜í™˜ (ê°ì • ìœ ì§€í•˜ì§€ ì•ŠìŒ)
            return False
